---
output:
  md_document:
    variant: markdown_github
---

<!-- badges: start -->
[![Travis build status](https://app.travis-ci.com/jaytimm/pubmedtk.svg?branch=main)](https://app.travis-ci.com/github/jaytimm/pubmedtk)
[![R-CMD-check](https://github.com/jaytimm/pubmedtk/workflows/R-CMD-check/badge.svg)](https://github.com/jaytimm/pubmedtk/actions)
<!-- badges: end -->



# pubmedtk

> The package provides a user-friendly, single-interface solution for accessing various PubMed endpoints, including [PubMed](https://pubmed.ncbi.nlm.nih.gov/) abstract records, [iCite](https://icite.od.nih.gov/) bibliometric data, [PubTator](https://www.ncbi.nlm.nih.gov/research/pubtator/) named entity annotations, and full-text entries from [PubMed Central](https://www.ncbi.nlm.nih.gov/pmc/) (PMC). 

> (With two simple functions) , the package simplifies the complexities of data retrieval and processing, ensuring uniform output across a diverse set of data sources. Facilitates batch retrieval of data for enhanced performance.  Suited for systematic literature reviews, meta-analyses, network analysis, and text mining.


> Each service you mentioned (PubMed abstract records, iCite bibliometric data, PubTator named entity annotations, and full-text entries from PubMed Central) provides different functionalities, and each of these functionalities is accessed through their respective API endpoints. 

> Your package would thus serve as an interface to these endpoints, allowing users to retrieve various types of data from these distinct services under the umbrella of PubMed's offerings.

> This unified interface approach greatly simplifies the process for end-users, who can interact with multiple PubMed services through a single R package rather than having to individually handle the different APIs and data formats of each service.


Also:

https://github.com/jaytimm/mesh-builds



## Installation

You can download the development version from GitHub with:

```{r message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
```


```{r eval=FALSE}
devtools::install_github("jaytimm/pubmedtk")
```



## Quick start

### PubMed search

The `pmed_search_pubmed()` function is meant for record-matching searches typically performed using the [PubMed online interface](https://pubmed.ncbi.nlm.nih.gov/).  

> pmed_get_records()


```{r}
yrs <- 2010:2023
pubmed_query <- paste0('("medical marijuana"[MeSH Terms]) AND (',
                       yrs, ':', yrs,  
                       '[pdat])')

pmids <- lapply(pubmed_query, pubmedtk::pmed_search_pubmed)
pmids <- pmids |> unlist() |> unique() |> sort()
```



```{r eval=FALSE, include=FALSE}
batch_size <- 199
batches <- split(pmids, ceiling(seq_along(pmids) / batch_size))

records <- pubmedtk:::.fetch_records(x = batches[[1]])
x <- records[[1]]
```



### Get record-level data

```{r}
pubmed_data <-pmids |> pubmedtk::pmed_get_data(endpoint = 'pubmed') 
pubmed_affs <- pmids |> pubmedtk::pmed_get_data(endpoint = 'affiliations')

icites_data <- med_cannabis |> pubmedtk::pmed_get_data(endpoint = 'icites')
pubtations_data <- med_cannabis |> pubmedtk::pmed_get_data(endpoint = 'pubtations')
```




### Extract full text articles

> so this could be re-worked to be PMID-based as well -- with the download, etc happening under the hood as it were -- 

```{r}
pmclist <- pubmedtk::data_pmc_list()
pmc_med_cannabis <- pmclist[PMID %in% med_cannabis]

pubmed_data <- pmc_med_cannabis$fpath |> pubmedtk::pmed_get_data(task_type = 'pmc')
```





## Retrieve and parse abstract data 

### Record details



```{r warning=FALSE}
med_cannabis_df0 <- pubmedtk::pmed_get_records2(pmids = med_cannabis[1:300], 
                                              with_annotations = T,
                                              verbose = F,
                                              cores = 3) |>
  data.table::rbindlist() |> filter(!is.na(abstract))
```



```{r}
n <- 1
list(pmid = med_cannabis_df0$pmid[n],
     year = med_cannabis_df0$year[n],
     journal = med_cannabis_df0$journal[n],
     articletitle = strwrap(med_cannabis_df0$articletitle[n], width = 60),
     abstract = strwrap(med_cannabis_df0$abstract[n], width = 60)[1:10])
```




### MeSH Annotations

> Annotations are included as a list-column (in ouput from `pmed_get_records2`), and can be easily extracted:

```{r}
annotations <- data.table::rbindlist(med_cannabis_df0$annotations)
```



```{r}
annotations |>
  filter(!is.na(FORM)) |>
  slice(1:10) |>
  knitr::kable()
```



### Affiliations

The `pmed_get_affiliations` function extracts author and author affiliation information from PubMed records. This is functionally the same call as `pmed_get_records2` -- presented here as an independent function for simplicity in output. 

```{r}
pubmedtk::pmed_get_affiliations(pmids = med_cannabis_df0$pmid) |>
  bind_rows() |>
  slice(1:10) |>
  knitr::kable()
```



## Citation data

The `pmed_get_icites` function can be used to obtain citation data per PMID using NIH's Open Citation Collection and [iCite](https://icite.od.nih.gov/).  

> Hutchins BI, Baker KL, Davis MT, Diwersy MA, Haque E, Harriman RM, et al. (2019) The NIH Open Citation Collection: A public access, broad coverage resource. PLoS Biol 17(10): e3000385. https://doi.org/10.1371/journal.pbio.3000385



### Summary data

The iCite API returns a host of descriptive/derived citation details per record.  

```{r}
citations <- pubmedtk::pmed_get_icites(pmids = med_cannabis_df0$pmid)

c0 <- citations |> select(-citation_net) |> slice(4)
setNames(data.frame(t(c0[,-1])), c0[,1]) |> knitr::kable()
```


### Network data

> Referenced and cited-by PMIDs are returned by the function as a column-list of network edges. 

```{r}
citations$citation_net[[1]] |> head()
```



## Biomedical concepts via the Pubtator Central API

> Wei, C. H., Allot, A., Leaman, R., & Lu, Z. (2019). PubTator central: automated concept annotation for biomedical full text articles. Nucleic acids research, 47(W1), W587-W593.

```{r}
pubtations <- med_cannabis[1:10] |>
  pubmedtk::pmed_get_entities(cores = 2) |>
  data.table::rbindlist()

pubtations |> na.omit() |> slice(1:20) |> knitr::kable()
```



## Full text from Open Acess PMC

### Load list of Open Access PMC articles 

```{r}
pmclist <- pubmedtk::data_pmc_list()
pmc_med_cannabis <- pmclist |> filter(PMID %in% med_cannabis)
pmc_med_cannabis |> head() |> knitr::kable()
```



### Extract full text articles

```{r}
med_cannabis_fulltexts <- pmc_med_cannabis$fpath[1] |> 
  pubmedtk::pmed_get_fulltext()
  #pubmedtk::pmed_get_fulltext()

samp <- med_cannabis_fulltexts |> 
  filter(pmcid %in% pmc_med_cannabis$PMCID[1])

lapply(samp$text, function(x){strwrap(x, width = 60)[1:3]})
```



## MeSH extensions

### Thesauri

```{r message=FALSE, warning=FALSE}
mesh <- pubmedtk::data_mesh_thesuarus() 
mesh |> head() |> knitr::kable()
```


### Trees

```{r message=FALSE, warning=FALSE}
pubmedtk::data_mesh_trees() |> head() |> knitr::kable()
```


### Pharmacological Actions

```{r message=FALSE, warning=FALSE}
pubmedtk::data_pharm_action() |> 
  filter(DescriptorName == 'Rituximab') |>
  knitr::kable()
```



### Embeddings

> Noh, J., & Kavuluru, R. (2021). Improved biomedical word embeddings in the transformer era. Journal of Biomedical Informatics, 120, 103867.

https://www.sciencedirect.com/science/article/pii/S1532046421001969

https://zenodo.org/record/4383195

Includes embeddings for the ~30K MeSH descriptors, as well as ~15K embeddings for Supplementary Concept Records (SCR).

