---
output:
  md_document:
    variant: markdown_github
---

<!-- badges: start -->
[![Travis build status](https://app.travis-ci.com/jaytimm/pubmedtk.svg?branch=main)](https://app.travis-ci.com/github/jaytimm/pubmedtk)
[![R-CMD-check](https://github.com/jaytimm/pubmedtk/workflows/R-CMD-check/badge.svg)](https://github.com/jaytimm/pubmedtk/actions)
<!-- badges: end -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("/home/jtimm/pCloudDrive/GitHub/packages/render_toc.R")
```



`r paste0('*Updated: ', Sys.Date(),'*')` 

# pubmedtk

An R package for (1) querying the PubMed database & parsing retrieved records; (2) extracting full text articles from the Open Access subset of the PMC via ftp; (3) obtaining citation data from NIH's Open Citation Collection/[iCite](https://icite.od.nih.gov/); and (4) accessing annotations of biomedical concepts from [PubTator Central](https://www.ncbi.nlm.nih.gov/research/pubtator/).


```{r echo=FALSE}
render_toc(filename = "/home/jtimm/pCloudDrive/GitHub/packages/pubmedtk/README.Rmd")#,
           # toc_depth = 3,
           # base_level = 2)
```


## Installation

You can download the development version from GitHub with:

```{r message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
```


```{r eval=FALSE}
devtools::install_github("jaytimm/pubmedtk")
```


## PubMed search

### Basic search

The `pmed_search_pubmed()` function is meant for record-matching searches typically performed using the [PubMed online interface](https://pubmed.ncbi.nlm.nih.gov/).  


```{r}
yrs <- 2010:2023
pubmed_query <- paste0('("medical marijuana"[MeSH Terms]) AND (',
                       yrs, ':', yrs,  
                       '[pdat])')

med_cannabis <- lapply(pubmed_query, pubmedtk::pmed_search_pubmed)
med_cannabis <- med_cannabis |> unlist() |> unique()
```



```{r}
head(med_cannabis)
```



## Retrieve and parse abstract data 

### Record details

```{r warning=FALSE}
med_cannabis_df0 <- pubmedtk::pmed_get_records2(pmids = med_cannabis[1:300], 
                                              with_annotations = T,
                                              verbose = F,
                                              cores = 3) |>
  data.table::rbindlist() |> filter(!is.na(abstract))
```



```{r}
n <- 1
list(pmid = med_cannabis_df0$pmid[n],
     year = med_cannabis_df0$year[n],
     journal = med_cannabis_df0$journal[n],
     articletitle = strwrap(med_cannabis_df0$articletitle[n], width = 60),
     abstract = strwrap(med_cannabis_df0$abstract[n], width = 60)[1:10])
```




### MeSH Annotations

> Annotations are included as a list-column (in ouput from `pmed_get_records2`), and can be easily extracted:

```{r}
annotations <- data.table::rbindlist(med_cannabis_df0$annotations)
```



```{r}
annotations |>
  filter(!is.na(FORM)) |>
  slice(1:10) |>
  knitr::kable()
```



### Affiliations

The `pmed_get_affiliations` function extracts author and author affiliation information from PubMed records. This is functionally the same call as `pmed_get_records2` -- presented here as an independent function for simplicity in output. 

```{r}
pubmedtk::pmed_get_affiliations(pmids = med_cannabis_df0$pmid) |>
  bind_rows() |>
  slice(1:10) |>
  knitr::kable()
```



## Citation data

The `pmed_get_icites` function can be used to obtain citation data per PMID using NIH's Open Citation Collection and [iCite](https://icite.od.nih.gov/).  

> Hutchins BI, Baker KL, Davis MT, Diwersy MA, Haque E, Harriman RM, et al. (2019) The NIH Open Citation Collection: A public access, broad coverage resource. PLoS Biol 17(10): e3000385. https://doi.org/10.1371/journal.pbio.3000385



### Summary data

The iCite API returns a host of descriptive/derived citation details per record.  

```{r}
citations <- pubmedtk::pmed_get_icites(pmids = med_cannabis_df0$pmid)

c0 <- citations |> select(-citation_net) |> slice(4)
setNames(data.frame(t(c0[,-1])), c0[,1]) |> knitr::kable()
```


### Network data

> Referenced and cited-by PMIDs are returned by the function as a column-list of network edges. 

```{r}
citations$citation_net[[1]] |> head()
```



## Biomedical concepts via the Pubtator Central API

> Wei, C. H., Allot, A., Leaman, R., & Lu, Z. (2019). PubTator central: automated concept annotation for biomedical full text articles. Nucleic acids research, 47(W1), W587-W593.

```{r}
pubtations <- med_cannabis[1:10] |>
  pubmedtk::pmed_get_entities(cores = 2) |>
  data.table::rbindlist()

pubtations |> na.omit() |> slice(1:20) |> knitr::kable()
```



## Full text from Open Acess PMC

### Load list of Open Access PMC articles 

```{r}
pmclist <- pubmedtk::data_pmc_list()
pmc_med_cannabis <- pmclist |> filter(PMID %in% med_cannabis)
pmc_med_cannabis |> head() |> knitr::kable()
```



### Extract full text articles

```{r}
med_cannabis_fulltexts <- pmc_med_cannabis$fpath[1] |> 
  pubmedtk::pmed_get_fulltext()
  #pubmedtk::pmed_get_fulltext()

samp <- med_cannabis_fulltexts |> 
  filter(pmcid %in% pmc_med_cannabis$PMCID[1])

lapply(samp$text, function(x){strwrap(x, width = 60)[1:3]})
```



## MeSH extensions

### Thesauri

```{r message=FALSE, warning=FALSE}
mesh <- pubmedtk::data_mesh_thesuarus() 
mesh |> head() |> knitr::kable()
```


### Trees

```{r message=FALSE, warning=FALSE}
pubmedtk::data_mesh_trees() |> head() |> knitr::kable()
```


### Pharmacological Actions

```{r message=FALSE, warning=FALSE}
pubmedtk::data_pharm_action() |> 
  filter(DescriptorName == 'Rituximab') |>
  knitr::kable()
```



### Embeddings

> Noh, J., & Kavuluru, R. (2021). Improved biomedical word embeddings in the transformer era. Journal of Biomedical Informatics, 120, 103867.

https://www.sciencedirect.com/science/article/pii/S1532046421001969

https://zenodo.org/record/4383195

Includes embeddings for the ~30K MeSH descriptors, as well as ~15K embeddings for Supplementary Concept Records (SCR).


```{r message=FALSE, warning=FALSE}
embeddings <- pubmedtk::data_mesh_embeddings()

pubmedtk::pmed_get_neighbors(x = embeddings,
                            target = 'Rituximab') |>
  knitr::kable()
```


```{r eval=FALSE, include=FALSE}
terms <- c('cannabis', 
           'rituximeb', 
           'white patients', 
           'community activism')

lapply(terms, function(x){pmed_link_mesh(x, dict = mesh)})

pmed_link_mesh(x = 'echinacea', dict = mesh)
```


